<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>
 	<link href="stylesheet/a.screen.css" rel="stylesheet" type="text/css" media="screen, projection"/>
	<!--[if lt IE 7]>
	  <link href="stylesheet/b.ie.css" rel="stylesheet" type="text/css" media="screen, projection" />
	<![endif]-->
 	<link href="stylesheet/c.styles.css"rel="stylesheet" type="text/css" media="screen, projection"/>
</head>
<body>
	<div class="container">
		<div id="cal_wrapper" class="span-21 prepend-2">
			<div id="cal_header" class="span-19">
				<div class="calheading first weekend">Sun</div>
				<div class="calheading">Mon</div>
				<div class="calheading">Tue</div>
				<div class="calheading">Wed</div>
				<div class="calheading">Thu</div>
				<div class="calheading">Fri</div>
				<div class="calheading weekend">Sat</div>
			</div>
			<div id="cal_body" class="span-19">
				<div class="span-6">
					<div class="this-month-year">
						<h1 class="this-month">January</h1>
						<h2 class='this-year'>2015</h2>
					</div>
					<p id="today_date">January 11, 2015</p>
					<img id="today_date_img" width="229" src="http://www.kidsmathgamesonline.com/images/pictures/numbers600/number11.jpg">
					<p id="today_caption">Title: <b>Number 11</b> - Free Picture of the <b>Number</b> Eleven</p>
					<p id="today_source">Source: www.kidsmathgamesonline.com</p>
				</div>
				<div id="cal_datecell">
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-1 cal-cellsetting">1</div>
					<div class="cal-day d-2 cal-cellsetting">2</div>
					<div class="cal-day d-3 cal-cellsetting">3</div>
					<div class="cal-day d-4 cal-cellsetting">4</div>
					<div class="cal-day d-5 cal-cellsetting">5</div>
					<div class="cal-day d-6 cal-cellsetting">6</div>
					<div class="cal-day d-7 cal-cellsetting">7</div>
					<div class="cal-day d-8 cal-cellsetting">8</div>
					<div class="cal-day d-9 cal-cellsetting">9</div>
					<div class="cal-day d-10 cal-cellsetting">10</div>
					<div class="cal-day today d-11">11</div>
					<div class="cal-day d-12 cal-cellsetting">12</div>
					<div class="cal-day d-13 cal-cellsetting">13</div>
					<div class="cal-day d-14 cal-cellsetting">14</div>
					<div class="cal-day d-15 cal-cellsetting">15</div>
					<div class="cal-day d-16 cal-cellsetting">16</div>
					<div class="cal-day d-17 cal-cellsetting">17</div>
					<div class="cal-day d-18 cal-cellsetting">18</div>
					<div class="cal-day d-19 cal-cellsetting">19</div>
					<div class="cal-day d-20 cal-cellsetting">20</div>
					<div class="cal-day d-21 cal-cellsetting">21</div>
					<div class="cal-day d-22 cal-cellsetting">22</div>
					<div class="cal-day d-23 cal-cellsetting">23</div>
					<div class="cal-day d-24 cal-cellsetting">24</div>
					<div class="cal-day d-25 cal-cellsetting">25</div>
					<div class="cal-day d-26 cal-cellsetting">26</div>
					<div class="cal-day d-27 cal-cellsetting">27</div>
					<div class="cal-day d-28 cal-cellsetting">28</div>
					<div class="cal-day d-29 cal-cellsetting">29</div>
					<div class="cal-day d-30 cal-cellsetting">30</div>
					<div class="cal-day d-31 cal-cellsetting">31</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
					<div class="cal-day d-&nbsp; cal-cellsetting">&nbsp;</div>
				</div>
			</div>
		</div>
	</div>
</body>
	<script type="text/javascript">
	/* todo:
		1. use same image for small-large today date.
		2. filter (square images only!?) to crop  properly.
	*/
	$(document).ready(function(){
		var todaydate=new Date();
		var curmonth=todaydate.getMonth()+1 //get current month (1-12)
		var curyear=todaydate.getFullYear() //get current year
		$('#cal_wrapper').append(buildCal(curmonth,curyear));

		var todaySearchDate = todaydate.getDate();
		var todaySearchTerm = "number " + todaySearchDate;
		var todayRequestURL = constructReQuestURL(todaySearchTerm);
		requestImage(todayRequestURL,'forToday',0);
		var searchTerm = "number 0";
		for(i=1;i<=31;i++) {
			searchTerm = searchTerm.substr(0,7).concat(i);
			requestUrl = constructReQuestURL(searchTerm);
			requestImage(requestUrl,'forOtherDays',i)
		}
	});

	buildCal = function(m,y){
		var month=['January','February','March','April','May','June','July','August','September','October','November','December'];
		var dim=[31,0,31,30,31,30,31,31,30,31,30,31];
		var date = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
		var oD = new Date(y, m-1, 1); //DD replaced line to fix date bug when current day is 31st
		oD.od=oD.getDay()+1; //DD replaced line to fix date bug when current day is 31st

		var todaydate=new Date() //DD added
		var scanfortoday=(y==todaydate.getFullYear() && m==todaydate.getMonth()+1)? todaydate.getDate() : 0 //DD added
		dim[1]=(((oD.getFullYear()%100!=0)&&(oD.getFullYear()%4==0))||(oD.getFullYear()%400==0))?29:28;

		// output header
		var html='<div id="cal_header" class="span-19 dbg-bdr-red">';
		for(i=0;i<7;i++)
			//console.log(date[i])
			switch(date[i]) {
				case 'Sun': html+='<div class="calheading first weekend">'+date[i]+'</div>';
					break;
				case 'Sat': html+='<div class="calheading weekend">'+date[i]+'</div>';
					break;
				default: html+='<div class="calheading">'+date[i]+'</div>';
			}
		html+='</div>';

		//output body
		var d=new Date();
		var strDate = month[m-1]+' '+d.getDate()+', '+y;

		// body of calendar
		html+='<div id="cal_body" class="span-19 dbg-bdr-green">';

		// left side
		html+='<div class="span-6">';
		html+='<div class="this-month-year dbg-bdr-orange"><h1 class="this-month">' + month[m-1]+ '</h1>';
		html+='<h2 class="this-year">' + y + '</h2></div>';
		html+='<p id="today_date" class="dbg-bdr-red">'+strDate+'</p>';
		html+='<img id="today_date_img" width="229" class="dbg-bdr-red"/>';
		html+='<p id="today_caption" class="dbg-bdr-red">Title:</p>';
		html+='<p id="today_source" class="dbg-bdr-red">Image source:</p>';
		html+='</div>';

		//output date: right side
		html+='<div id="cal_datecell" class="dbg-bdr-red">';
		for(i=1;i<=42;i++){
			var x=((i-oD.od>=0)&&(i-oD.od<dim[m-1]))? i-oD.od+1 : '&nbsp;';
			if (x==scanfortoday) {
				html+='<div class="cal-day today '+'d-'+x+'">';
			} else {
				html+='<div class="cal-day '+'d-'+x+' cal-cellsetting">';
			}
			html+= x+'</div>';
		}
		html+='</div></div>'
		return html;
	}

	// create reuqest query
	constructReQuestURL = function (searchTerm) {
		var URL = "http://ajax.googleapis.com/ajax/services/search/images" +
			"?v=1.0" +
			"&q=" + searchTerm +
			"&rsz=3" +
			"&callback=?"
		return encodeURI(URL);
	}

	requestImage = function(requestURL,forWhat,callNum) {
		$.getJSON(requestURL,
			function(data){
				// console.log(data);
				var numRand = Math.floor(Math.random()*(data.responseData.results.length+1));
				$.each(data.responseData.results, function(i,result){
					if(i == numRand) {
						switch (forWhat) {
							// today layout requires a large image, its title and source
							case 'forToday' : {
								// console.log(result.url);
								// console.log(result.title)
								// console.log(result.visibleUrl);

								// var imgSource = result.MediaUrl.split('/');
								$("#cal_body > div > #today_date_img").attr('src',result.url);
								$("#cal_body > div > #today_caption").html('Title: ' + result.title);

								//trim the URL after domain name
								$("#cal_body > div > #today_source").html('Source: ' + result.visibleUrl);
							break
							}
							// other days require thumbnail
							case 'forOtherDays': {
								//console.log(result.Thumbnail.Url);
								calClass = '.d-' + callNum;
								$(calClass).css({'background-image':'url('+result.tbUrl+')'});
							break;
							}
						} // end switch
					}
				}); // end each
		}); // end getJSON
	}
	</script>